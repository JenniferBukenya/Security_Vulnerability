<?php
// Start the session
session_start();

// Require the database connection file
require_once 'db_connect.php';

// Check if the form is submitted
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // Check if username and password are set
    if (isset($_POST["username"]) && isset($_POST["password"])) {
        // Retrieve username and password from the form
        $username = $_POST["username"];
        $password = $_POST["password"];

        // Prepare the SQL statement to check if the user exists
        $check_user_sql = "SELECT * FROM users WHERE username = :username";
        $stmt_check_user = $pdo->prepare($check_user_sql);
        $stmt_check_user->bindParam(':username', $username, PDO::PARAM_STR);
        $stmt_check_user->execute();

        // Fetch the user record
        $user = $stmt_check_user->fetch(PDO::FETCH_ASSOC);

        // Check if a user with the provided username exists
        if ($user) {
            // Verify password
            if (password_verify($password, $user['password'])) {
                // Password is correct
                // Store user data in session variables
                $_SESSION["user_id"] = $user["id"];
                $_SESSION["username"] = $user["username"];

                // Redirect to the dashboard or any other page
                header("Location: fetchstudents.php");
                exit(); // Always include exit after header redirect to prevent further script execution
            } else {
                // Password is incorrect
                $error = "Wrong Password.";
                echo ($error);
            }
        } else {
            // User not found
            $error = "User not found.";
            echo ($error);
        }
    }
}
